<!doctype html>
<html lang="fr">
<head>
  <meta charset="utf-8" />
  <link rel="icon" type="image/png" href="favicon.png">
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>TicketEase — Espace Pro (Démo)</title>
  <meta name="color-scheme" content="dark light" />
  <style>
    :root{
      /* Palette premium (fond sombre + accent bleu profond) */
      --bg:#070a0f; --surface:#0a0f15; --card:#0c1219; --text:#eaf1f7; --muted:#9fb0bf; --border:rgba(255,255,255,.10);
      --accent:#1256d8;           /* bleu profond */
      --accent-strong:#0e49bd;    /* plus sombre pour base */
      --accent-glow:0 10px 40px rgba(18,86,216,.25);
      --ok:#18c29c; --warn:#ffb454; --danger:#ff6b6b;

      --glass:linear-gradient(180deg, rgba(255,255,255,.06), rgba(255,255,255,.02));
      --glass-border:1px solid rgba(255,255,255,.12);
      --shadow-lg:0 30px 120px rgba(0,0,0,.55), inset 0 1px 0 rgba(255,255,255,.03);
      --shadow-md:0 16px 60px rgba(0,0,0,.45);
      --radius-xl:20px; --radius:14px; --radius-sm:11px;

      --sans:ui-sans-serif, -apple-system, BlinkMacSystemFont, "SF Pro Text","Segoe UI", Roboto, Arial, "Apple Color Emoji","Segoe UI Emoji";
      --mono:ui-monospace, SFMono-Regular, Menlo, Monaco, Consolas, "Liberation Mono", monospace;

      /* Couleurs dégradés décoratifs (sombre) */
      --g-green: rgba(44,209,158,.26);
      --g-pink:  rgba(255,105,180,.22);
      --g-green-soft: rgba(44,209,158,.18);
      --chip-bg:#0b131b;
      --chip-text:var(--text);
      --g-blue-deep: #0b2a7a; /* pour le ruban bas */
    }
    @media (prefers-color-scheme: light){
      :root{
        --bg:#f6f8fb; --surface:#f9fbfd; --card:#ffffff; --text:#0c1723; --muted:#617386; --border:rgba(0,0,0,.08);
        --accent:#0b5bd3; --accent-strong:#0a4dbc; --glass:linear-gradient(180deg, rgba(0,0,0,.03), rgba(0,0,0,.01));
        --glass-border:1px solid rgba(0,0,0,.08);
        --shadow-lg:0 30px 120px rgba(0,0,0,.12);
        --shadow-md:0 16px 60px rgba(0,0,0,.10);

        /* Dégradés plus doux en clair */
        --g-green: rgba(44,209,158,.20);
        --g-pink:  rgba(255,105,180,.18);
        --g-green-soft: rgba(44,209,158,.14);
        --g-blue-deep: #0b3aa2;
	--muted:#3b4b5c;           /* un poil plus contrasté en clair */
        --chip-bg:#e9eef5;         /* pastille claire */
        --chip-text:#0c1723;       /* texte très lisible */
      }
    }

    *{ box-sizing:border-box }
    html,body{ height:100% }
    body{
      margin:0; padding:32px; color:var(--text); font-family:var(--sans); letter-spacing:.1px;
      /* Dégradé premium latéral : verts & roses sur les côtés, discret au centre */
      background:
        radial-gradient(800px 520px at -12% 35%, var(--g-green), transparent 55%),
        radial-gradient(820px 520px at 112% 35%, var(--g-pink), transparent 55%),
        radial-gradient(700px 420px at 50% 120%, var(--g-green-soft), transparent 65%),
        var(--bg);
    }
    /* Ruban dégradé en bas (derrière le contenu) */
    .ribbon{
      position:fixed; left:0; right:0; bottom:0; height:120px; pointer-events:none; z-index:0;
      background:
        linear-gradient(90deg,
          color-mix(in oklab, #23d7a2 80%, transparent) 0%,
          color-mix(in oklab, #ff73bf 90%, transparent) 45%,
          color-mix(in oklab, var(--g-blue-deep) 100%, transparent) 100%);
      /* Fondu vers le haut pour ne pas “manger” le contenu */
      -webkit-mask-image: linear-gradient(to top, rgba(0,0,0,.9), rgba(0,0,0,0));
              mask-image: linear-gradient(to top, rgba(0,0,0,.9), rgba(0,0,0,0));
      filter: saturate(1.1) blur(0.2px);
    }

    .wrap{ max-width:1080px; margin:0 auto; position:relative; z-index:1 }

    /* Header */
    header{ display:flex; align-items:center; justify-content:space-between; gap:18px; flex-wrap:wrap; margin-bottom:18px }
    .brand{ display:flex; align-items:center; gap:14px }
    .logo{
      width:58px; height:58px; border-radius:16px; background:var(--glass); border:var(--glass-border);
      display:grid; place-items:center; box-shadow:var(--shadow-lg)
    }
    .logo img{ width:36px; height:36px; filter:drop-shadow(0 2px 10px rgba(18,86,216,.35)) }
    .title{ margin:0; font-weight:800; font-size:22px }
    .subtitle{ margin:2px 0 0; color:var(--muted); font-size:13px }

    /* Hero */
    .hero{
      display:flex; align-items:center; justify-content:space-between; gap:16px; padding:22px 22px;
      background:var(--glass); border:var(--glass-border); border-radius:var(--radius-xl); box-shadow:var(--shadow-md)
    }
    .hero h2{ margin:0 0 4px 0; font-size:20px }
    .hero .sub{ color:var(--muted); font-size:13px }

    /* Layout */
    .grid{ display:grid; gap:16px; grid-template-columns:1.18fr .82fr }
    @media (max-width:980px){ .grid{ grid-template-columns:1fr } }

    /* Surfaces */
    .card{
      background:var(--card); border:var(--glass-border); border-radius:var(--radius-xl); box-shadow:var(--shadow-md); padding:18px
    }
    .stack{ display:grid; gap:14px }
    .section-title{ margin:0; font-weight:700; letter-spacing:.2px }

    /* Forms & buttons */
    label{ display:block; font-size:12px; color:var(--muted); margin:0 0 6px 2px }
    .row{ display:flex; gap:10px; flex-wrap:wrap; align-items:flex-end }
    .cols2{ display:grid; gap:12px; grid-template-columns:1fr 1fr }
    @media (max-width:720px){ .cols2{ grid-template-columns:1fr } }
    .inp{ flex:1 1 240px; min-width:220px }

    input{
      width:100%; padding:12px 14px; border-radius:12px; border:1px solid var(--border);
      background:linear-gradient(180deg, rgba(255,255,255,.02), rgba(255,255,255,0)) , #0b1117; color:var(--text); font-size:14px;
      outline:none; transition:border .18s ease, box-shadow .18s ease, transform .02s ease;
    }
    @media (prefers-color-scheme: light){ input{ background:#fff } }
    input:hover{ border-color:rgba(255,255,255,.16) }
    input:focus{ border-color:var(--accent); box-shadow:0 0 0 5px rgba(18,86,216,.18) }

    .btn{
      background:var(--accent-strong); border:none; border-radius:12px; padding:12px 16px; font-weight:700; color:#fff; cursor:pointer;
      transition:transform .06s, background .2s, box-shadow .2s; font-size:14px; letter-spacing:.2px
    }
    .btn:hover{ background:var(--accent); box-shadow:var(--accent-glow) }
    .btn:active{ transform:translateY(1px) scale(.985) }
    .btn-ghost{
      background:transparent; border:1px solid var(--border); color:var(--text); font-weight:600;
      backdrop-filter:saturate(1.2) blur(2px)
    }
    .btn-ghost:hover{ box-shadow:0 8px 26px rgba(0,0,0,.28) }
    .btn[aria-busy="true"]{ position:relative; pointer-events:none; opacity:.9 }
    .btn[aria-busy="true"]::after{
      content:""; position:absolute; right:12px; top:50%; width:14px; height:14px; transform:translateY(-50%);
      border-radius:50%; border:2px solid rgba(255,255,255,.7); border-top-color:transparent; animation:spin .8s linear infinite
    }
    @keyframes spin{ to{ transform:translateY(-50%) rotate(360deg) } }

    /* Status chips */
    .chips{ display:flex; gap:8px; flex-wrap:wrap }
    .chip{
  	display:inline-flex; align-items:center; gap:7px;
  	padding:7px 10px; border-radius:999px; font-size:12px;
  	background:var(--chip-bg);
  	color:var(--chip-text);
  	border:1px solid var(--border);
    }
    .dot{ width:8px; height:8px; border-radius:50% }
    .dot.ok{ background:var(--ok) } .dot.warn{ background:var(--warn) } .dot.off{ background:#586471 }

    /* Code areas */
    pre{
      font-family:var(--mono); font-size:12.5px; background:#0a0f15; color:#d2d9e0; border:1px solid var(--border);
      border-radius:12px; padding:12px; overflow:auto; min-height:120px; max-height:320px
    }
    @media (prefers-color-scheme: light){ pre{ background:#0b1220; color:#e5e7eb } }

    details{ border:var(--glass-border); border-radius:16px; padding:12px 13px; background:var(--glass) }
    summary{ cursor:pointer; font-weight:700; letter-spacing:.2px }

    .kbd{ font-family:var(--mono); font-size:12px; background:rgba(255,255,255,.06); padding:3px 7px; border-radius:8px; border:1px solid var(--border) }

    /* Toast */
    .toast{ position:fixed; right:18px; bottom:18px; background:var(--card); color:var(--text);
      border:var(--glass-border); border-radius:12px; padding:10px 12px; box-shadow:var(--shadow-md); max-width:420px }

    footer{ margin-top:16px; color:var(--muted); font-size:12px; display:flex; gap:8px; flex-wrap:wrap; align-items:center }
  </style>
</head>
<body>
<div class="wrap">
  <header>
    <div class="brand">
      <div class="logo"><img id="logo" alt="TicketEase" src="https://placehold.co/72x72/ffffff/000000?text=TE" /></div>
      <div>
        <h1 class="title">TicketEase — Espace Pro (Démo)</h1>
        <p class="subtitle">Connectez votre banque. Enregistrez l'Email de votre choix. C’est tout.</p>
      </div>
    </div>
    <div class="subtitle">Astuce&nbsp;: <span class="kbd">⌘/Ctrl</span> + <span class="kbd">S</span> pour enregistrer</div>
  </header>

  <!-- Bandeau -->
  <section class="hero">
    <div>
      <h2>Configuration rapide</h2>
      <div class="sub">Renseignez l’API du Worker et l’email client (utilisé pour l’envoi du ticket).</div>
      <div class="chips" style="margin-top:10px">
        <span class="chip"><span id="chipApi" class="dot off"></span><span id="chipApiTxt">API non définie</span></span>
        <span class="chip"><span id="chipEmail" class="dot off"></span><span id="chipEmailTxt">Email manquant</span></span>
        <span class="chip"><span id="chipConn" class="dot off"></span><span id="chipConnTxt">Banque non connectée</span></span>
      </div>
    </div>
    <div class="row">
      <button id="connectPowens" class="btn">Connecter votre banque</button>
    </div>
  </section>

  <div style="height:14px"></div>

  <div class="grid">
    <!-- Colonne principale -->
    <section class="card stack" aria-labelledby="core-title">
      <h3 id="core-title" class="section-title">Vos paramètres</h3>
      <div class="cols2">
        <div class="inp">
          <label for="apiBase">API Base (Worker)</label>
          <input id="apiBase" placeholder="https://complet.contact-ticketise.workers.dev" spellcheck="false" />
        </div>
        <div class="inp">
          <label for="customerEmail">Email client</label>
          <input id="customerEmail" placeholder="client@example.test" />
        </div>
      </div>
      <div class="row">
        <button id="saveBase" class="btn">Enregistrer</button>
        <button id="btnHealth" class="btn btn-ghost">/health</button>
        <button id="btnVersion" class="btn btn-ghost">/__version</button>
        <button id="statusPowens" class="btn btn-ghost">Statut connexion</button>
      </div>

      <!-- Intent courant repliable par défaut -->
      <details style="margin-top:6px">
        <summary>Intent courant</summary>
        <div class="cols2" style="margin-top:10px">
          <div class="inp">
            <label for="lastIntent">ID intent</label>
            <input id="lastIntent" aria-live="polite" placeholder="auto via Latest" />
          </div>
          <div class="row" style="align-items:flex-end">
            <button id="btnLatest" class="btn">Charger le dernier</button>
            <button id="getStatus" class="btn btn-ghost">Statut</button>
            <button id="resend" class="btn btn-ghost">Resend mail</button>
          </div>
        </div>

        <div class="cols2" style="margin-top:8px">
          <div class="inp">
            <label for="emailSet">Poser/mettre à jour l’email client</label>
            <input id="emailSet" placeholder="client@example.test" />
          </div>
          <div class="row" style="align-items:flex-end">
            <button id="btnSetEmail" class="btn">Appliquer à l’intent</button>
          </div>
        </div>
      </details>

      <details style="margin-top:6px">
        <summary>Options avancées</summary>
        <div class="cols2" style="margin-top:10px">
          <div class="inp">
            <label for="accountId">AccountId (prioritaire pour /nfc/pay)</label>
            <input id="accountId" placeholder="ex : 123456" />
          </div>
          <div class="inp">
            <label for="shortcutKey">Shortcut key (optionnel)</label>
            <input id="shortcutKey" placeholder="sk" />
          </div>
        </div>
        <div class="row" style="margin-top:8px">
          <button id="btnNfc" class="btn" style="background:var(--ok)">Déclencher paiement (NFC)</button>
        </div>
      </details>
    </section>

    <!-- Colonne droite -->
    <section class="card stack">
      <h3 class="section-title">Powens & cibles de montant</h3>

      <details open>
        <summary>Comptes & transactions</summary>
        <div class="row" style="margin-top:8px">
          <button id="listAccounts" class="btn btn-ghost">/powens/accounts</button>
          <button id="txns" class="btn btn-ghost">/powens/transactions</button>
        </div>
        <div class="inp" style="margin-top:8px">
          <label for="txAccount">AccountId utilisé pour /transactions</label>
          <input id="txAccount" placeholder="accountId" />
        </div>
      </details>

      <details>
        <summary>Montants matchables (/powens/tx-targets)</summary>
        <div class="cols2" style="margin-top:8px">
          <div class="inp">
            <label for="limitTargets">Limite</label>
            <input id="limitTargets" value="100" />
          </div>
          <div class="row" style="align-items:flex-end">
            <button id="btnTargets" class="btn btn-ghost">Charger</button>
            <button id="btnAccountsMirror" class="btn btn-ghost">Rafraîchir comptes</button>
          </div>
        </div>
        <div id="targets" class="chips" aria-live="polite" style="margin-top:8px"></div>
        <p class="subtitle" style="margin:8px 0 0">Clique un montant pour le copier (prépare tes paniers iPad).</p>
      </details>

      <h4 style="margin:10px 0 6px">Réponse API</h4>
      <pre id="response"></pre>
    </section>
  </div>

  <div class="card" style="margin-top:16px">
    <h3 class="section-title" style="margin:0 0 8px">Journal</h3>
    <pre id="log" style="min-height:120px; max-height:280px"></pre>
  </div>

  <footer>
    <span>API&nbsp;:</span>
    <span class="subtitle">/health • /__version • /latest-intent • /intent/set-email • /nfc/pay • /powens/tx-targets • /powens/connect • /powens/accounts • /powens/transactions • /intent-status • /admin/resend</span>
  </footer>
</div>

<!-- Ruban dégradé bas de page (hors flux, décoratif) -->
<div class="ribbon" aria-hidden="true"></div>

<div id="toast" class="toast" role="status" aria-live="polite" hidden></div>

<script>
(()=> {
  // ===== Helpers
  const $ = id => document.getElementById(id);
  const LOG = $('log'), RESP = $('response'), TOAST = $('toast');
  const merchant = 'DEMO';

  const DEFAULTS = {
    apiBase:'https://complet.contact-ticketise.workers.dev',
    logo:'https://placehold.co/72x72/ffffff/000000?text=TE'
  };
  const LS = {
    get k(){ return {
      base:'TE_API_BASE', last:'TE_LAST_INTENT', acc:'TE_ACCOUNT_ID', email:'TE_CUSTOMER_EMAIL',
      txacc:'TE_TX_ACCOUNT', logo:'TE_LOGO_URL', lim:'TE_TARGET_LIMIT', sk:'TE_SHORTCUT_KEY',
      connHint:'TE_CONN_HINT' // 'connected' | ''
    }}
  };
  const getLS = (k,f='') => localStorage.getItem(k) || f;
  const setLS = (k,v) => localStorage.setItem(k, v);
  const isEmail = s => /^[^\s@]+@[^\s@]+\.[^\s@]+$/.test(String(s||'').trim());

  function toast(msg, t=3000){ TOAST.textContent=msg; TOAST.hidden=false; clearTimeout(toast._t); toast._t=setTimeout(()=>TOAST.hidden=true,t); }
  function log(x){ const now = new Date().toLocaleTimeString(); const line = now+' — '+(typeof x==='string'?x:JSON.stringify(x,null,2)); LOG.textContent = line+'\n'+LOG.textContent; }
  function showResp(x){ RESP.textContent = typeof x==='string'? x : JSON.stringify(x,null,2); }
  function busy(btn, on){ if(!btn) return; on ? btn.setAttribute('aria-busy','true') : btn.removeAttribute('aria-busy'); }
  function base(){ const b=$('apiBase').value.trim(); if(!b){ alert("Définissez l'API Base"); throw new Error('API base manquante'); } return b; }
  async function api(path, opts={}){ const url = base()+path; const res = await fetch(url, { ...opts }); const txt = await res.text(); let data; try{ data=JSON.parse(txt) }catch{ data=txt } if(!res.ok){ const err=(data&&data.error)?data.error:(res.status+' '+res.statusText); throw new Error(typeof err==='string'?err:JSON.stringify(err)); } return data; }
  function centsStr(c){ const v=Number(c||0)/100; return v.toLocaleString('fr-FR',{minimumFractionDigits:2,maximumFractionDigits:2})+' €'; }

  // ===== Status chips
  const chipApi = $('chipApi'), chipApiTxt = $('chipApiTxt');
  const chipEmail = $('chipEmail'), chipEmailTxt = $('chipEmailTxt');
  const chipConn = $('chipConn'), chipConnTxt = $('chipConnTxt');
  function setDot(el, cls){ el.classList.remove('ok','warn','off'); el.classList.add(cls); }
  function refreshChipsBase(){
    const b = ($('apiBase').value||'').trim();
    const e = ($('customerEmail').value||'').trim();
    setDot(chipApi, b ? 'ok' : 'off'); chipApiTxt.textContent = b ? 'API définie' : 'API non définie';
    setDot(chipEmail, isEmail(e) ? 'ok' : (e ? 'warn' : 'off'));
    chipEmailTxt.textContent = isEmail(e) ? 'Email valide' : (e ? 'Email invalide' : 'Email manquant');
  }
  function setConn(status){
    if(status==='connected'){ setDot(chipConn,'ok'); chipConnTxt.textContent='Banque connectée'; setLS(LS.k.connHint,'connected'); }
    else { setDot(chipConn,'off'); chipConnTxt.textContent='Banque non connectée'; setLS(LS.k.connHint,''); }
  }

  // ===== Init UI state
  $('apiBase').value = getLS(LS.k.base, DEFAULTS.apiBase);
  $('customerEmail').value = getLS(LS.k.email, '');
  $('emailSet').value = getLS(LS.k.email, '');
  $('lastIntent').value = getLS(LS.k.last, '');
  $('accountId').value = getLS(LS.k.acc, '');
  $('txAccount').value = getLS(LS.k.txacc, '');
  $('shortcutKey').value = getLS(LS.k.sk, '');
  $('limitTargets').value = getLS(LS.k.lim, '100') || '100';
  $('logo').src = getLS(LS.k.logo, DEFAULTS.logo);
  refreshChipsBase();
  setConn(''); // par défaut gris

  // Hint de connexion optimiste si on revient de la webview
  if(getLS(LS.k.connHint,'')){
    // Affiche vert tout de suite, puis vérifie réellement
    setConn('connected');
    // vérification silencieuse
    (async ()=>{ try{
      const r = await api('/powens/connect/status');
      const ok = !!(r && (r.connected || r.status==='connected' || r.ok));
      setConn(ok ? 'connected' : '');
    }catch{ setConn(''); }})();
  }

  // Save (⌘/Ctrl + S)
  window.addEventListener('keydown', (e)=>{ if((e.metaKey||e.ctrlKey) && e.key.toLowerCase()==='s'){ e.preventDefault(); saveBase(); } });
  $('apiBase').addEventListener('input', refreshChipsBase);
  $('customerEmail').addEventListener('input', refreshChipsBase);

  function saveBase(){
    setLS(LS.k.base, $('apiBase').value.trim());
    setLS(LS.k.email, $('customerEmail').value.trim());
    setLS(LS.k.acc, $('accountId').value.trim());
    setLS(LS.k.txacc, $('txAccount').value.trim());
    setLS(LS.k.lim, $('limitTargets').value.trim());
    setLS(LS.k.sk, $('shortcutKey').value.trim());
    const email = $('customerEmail').value.trim();
    if (isEmail(email)) {
      fetch(base() + '/demo/set-email-once', {
        method:'POST', headers:{'Content-Type':'application/json'},
        body: JSON.stringify({ merchant, email })
      }).catch(()=>{});
    }
    toast('Configuration enregistrée'); log('Config saved'); refreshChipsBase();
  }
  $('saveBase').onclick = saveBase;

  // Auto push one-shot si changement
  const pushOneShot = async (email) => {
    if (!isEmail(email)) return;
    try{
      await api('/demo/set-email-once', { method:'POST', headers:{'Content-Type':'application/json'}, body: JSON.stringify({ merchant, email }) });
      log('email one-shot posé: ' + email);
    }catch(e){ log('set-email-once error: '+e.message); }
  };
  $('customerEmail').addEventListener('change', (e)=>{ const v=e.target.value.trim(); setLS(LS.k.email, v); pushOneShot(v); });
  $('emailSet').addEventListener('change', (e)=>{ const v=e.target.value.trim(); setLS(LS.k.email, v); pushOneShot(v); });

  // Health / Version
  $('btnHealth').onclick = async (e)=>{ try{ busy(e.target,true); const r=await api('/health'); showResp(r); toast('Health OK'); } catch(err){ log('health error: '+err.message); toast('Erreur /health'); } finally{ busy(e.target,false); } };
  $('btnVersion').onclick = async (e)=>{ try{ busy(e.target,true); const r=await api('/__version'); showResp(r); } catch(err){ log('version error: '+err.message); toast('Erreur /__version'); } finally{ busy(e.target,false); } };

  // Connexion Powens : bascule verte immédiatement (optimiste) + redirection webview
  $('connectPowens').onclick = async (e)=>{
    const win=window.open('about:blank','_blank','noopener');
    setConn('connected'); // feedback immédiat
    try{
      busy(e.target,true);
      const r=await api('/powens/connect',{method:'POST'});
      showResp(r);
      if(r.redirect_url){
        localStorage.setItem(LS.k.connHint,'connected'); // mémo pour le retour
        if(win) win.location.replace(r.redirect_url); else window.open(r.redirect_url,'_blank','noopener');
        log('Webview Powens ouverte');
      } else { if(win) win.close(); toast('redirect_url manquant'); setConn(''); }
    }catch(err){
      if(win) win.close();
      setConn('');
      log('connect error: '+err.message);
      toast('Échec connexion Powens');
    }finally{ busy(e.target,false); }
  };

  // Statut Powens (vérif explicite)
  $('statusPowens').onclick = async (e)=>{ try{
      busy(e.target,true);
      const r=await api('/powens/connect/status');
      showResp(r); log('connect status: '+JSON.stringify(r));
      const ok = !!(r && (r.connected || r.status==='connected' || r.ok));
      setConn(ok ? 'connected' : '');
    } catch(err){ log('status error: '+err.message); toast('Erreur statut connexion'); setConn(''); }
    finally{ busy(e.target,false); } };

  // Accounts & Transactions
  $('listAccounts').onclick = async (e)=>{ try{
      busy(e.target,true);
      const r=await api('/powens/accounts');
      showResp(r); log('accounts fetched');
      if(r.accounts && r.accounts[0]){
        $('txAccount').value = r.accounts[0].id; setLS(LS.k.txacc, r.accounts[0].id);
        if(!$('accountId').value){ $('accountId').value = r.accounts[0].id; setLS(LS.k.acc, r.accounts[0].id); }
      }
    } catch(err){ log('accounts error: '+err.message); toast('Erreur /accounts'); }
    finally{ busy(e.target,false); } };

  $('txns').onclick = async (e)=>{ try{
      busy(e.target,true);
      const acc=($('txAccount').value||'').trim(); if(!acc) return alert('Renseignez un accountId');
      const r=await api('/powens/transactions?accountId='+encodeURIComponent(acc));
      showResp(r); log('transactions fetched for '+acc);
    } catch(err){ log('txns error: '+err.message); toast('Erreur /transactions'); }
    finally{ busy(e.target,false); } };

  // Intents (dans le details repliable)
  $('btnLatest').onclick = async (e)=>{ try{
      busy(e.target,true);
      const r=await api('/latest-intent?merchant='+merchant);
      showResp(r);
      const it=r && r.intent;
      if(it && it.id){ $('lastIntent').value=it.id; setLS(LS.k.last,it.id); toast('Dernier intent chargé'); }
      else { toast('Aucun intent PENDING'); }
    } catch(err){ log('latest error: '+err.message); toast('Erreur /latest-intent'); }
    finally{ busy(e.target,false); } };

  $('btnSetEmail').onclick = async (e)=>{ try{
      busy(e.target,true);
      const id=($('lastIntent').value||getLS(LS.k.last,'')).trim(); if(!id) return alert('Aucun intent');
      const email=($('emailSet').value||$('customerEmail').value||'').trim(); if(!email) return alert('Email requis');
      if(!isEmail(email)) return alert('Email invalide');
      setLS(LS.k.email,email);
      const r=await api('/intent/set-email',{method:'POST',headers:{'Content-Type':'application/json'},body:JSON.stringify({merchant, id, email})});
      await api('/demo/set-email-once',{method:'POST',headers:{'Content-Type':'application/json'},body:JSON.stringify({merchant, email})});
      toast(r?.invalidEmail ? 'Email rejeté par Worker' : 'Email posé'); showResp(r); refreshChipsBase();
    }catch(err){ log('set-email error: '+err.message); toast('Erreur /intent/set-email'); }
    finally{ busy(e.target,false); } };

  $('getStatus').onclick = async (e)=>{ try{
      busy(e.target,true);
      const id=($('lastIntent').value||getLS(LS.k.last,'')).trim(); if(!id) return alert("Pas d'intent");
      const r=await api('/intent-status?merchant='+merchant+'&id='+encodeURIComponent(id));
      showResp(r); log({msg:'intent-status',r});
    } catch(err){ log('status error: '+err.message); toast('Erreur /intent-status'); }
    finally{ busy(e.target,false); } };

  $('resend').onclick = async (e)=>{ try{
      busy(e.target,true);
      const id=($('lastIntent').value||getLS(LS.k.last,'')).trim(); if(!id) return alert("Pas d'intent");
      const r=await api('/admin/resend',{method:'POST',headers:{'Content-Type':'application/json'},body:JSON.stringify({merchant, intentId:id})});
      showResp(r); log({msg:'admin/resend',r});
    } catch(err){ log('resend error: '+err.message); toast('Erreur /admin/resend'); }
    finally{ busy(e.target,false); } };

  // NFC (dans Avancé)
  $('btnNfc').onclick = async (e)=>{ try{
      busy(e.target,true);
      const qp = new URLSearchParams(); qp.set('merchant', merchant);
      const acc = ($('accountId').value||$('txAccount').value||'').trim(); if(acc) qp.set('accountId', acc);
      const sk  = ($('shortcutKey').value||'').trim(); if(sk){ qp.set('sk', sk); setLS(LS.k.sk, sk); }
      const email = ($('emailSet').value || $('customerEmail').value || '').trim();
      if (isEmail(email)) qp.set('email', email);
      const r = await api('/nfc/pay?'+qp.toString());
      showResp(r); toast('Paiement confirmé (NFC)');
      const consumedId = r?.attemptResult?.intentId || r?.id; if(consumedId){ $('lastIntent').value = consumedId; setLS(LS.k.last, consumedId); }
    } catch(err){ log('nfc error: '+err.message); toast('Erreur /nfc/pay'); }
    finally{ busy(e.target,false); } };

  // Tx targets
  $('btnTargets').onclick = async (e)=>{ try{
      busy(e.target,true);
      const acc = ($('accountId').value||$('txAccount').value||'').trim(); if(!acc) return alert('Choisissez un accountId');
      const limit= ($('limitTargets').value||'100').trim(); setLS(LS.k.lim, limit);
      const r = await api('/powens/tx-targets?accountId='+encodeURIComponent(acc)+'&limit='+encodeURIComponent(limit));
      showResp(r); renderTargets(r && r.targets || []);
    } catch(err){ log('tx-targets error: '+err.message); toast('Erreur /powens/tx-targets'); }
    finally{ busy(e.target,false); } };
  $('btnAccountsMirror').onclick = ()=> $('listAccounts').click();

  function renderTargets(list){
    const host=$('targets'); host.innerHTML='';
    if(!list.length){ host.innerHTML='<span class="subtitle">Aucune cible.</span>'; return; }
    list.slice(0,60).forEach(t=>{
      const btn=document.createElement('button');
      btn.className='btn btn-ghost'; btn.style.borderRadius='999px'; btn.style.padding='8px 10px'; btn.style.fontSize='12px';
      btn.title=t.label||'';
      btn.textContent=centsStr(t.amountCents)+(t.date?(' • '+t.date):'');
      btn.onclick=()=>{ navigator.clipboard&&navigator.clipboard.writeText(String(t.amountCents)).catch(()=>{}); toast('Montant copié'); };
      host.appendChild(btn);
    });
  }

})();
</script>
</body>
</html>